<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Трекер рабочих активностей</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        form { margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        input, select { padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-top: 15px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #007bff; color: white; }
        tr:hover { background: #f1f1f1; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<div id="app" class="container">
    <h1>Трекер активностей</h1>

    <div v-if="message" class="message success">{{ message }}</div>
    <div v-if="error" class="message error">{{ error }}</div>

    <form @submit.prevent="addInterval">
        <input type="time" v-model="form.startTime" required @change="updateSeconds" />
        <input type="time" v-model="form.endTime" required @change="updateSeconds" />

        <label>Тип активности</label>
        <select v-model="form.type" required>
            <option value="WORK">Работа</option>
            <option value="BREAK">Перерыв</option>
        </select>

        <button type="submit">Добавить интервал</button>
    </form>

    <h2>Список интервалов ({{ intervals.length }})</h2>
    <table v-if="intervals.length > 0">
        <thead>
        <tr>
            <th>ID</th>
            <th>Начало</th>
            <th>Конец</th>
            <th>Тип</th>
            <th>Длительность</th>
        </tr>
        </thead>
        <tbody>
        <tr v-for="interval in intervals" :key="interval.id">
            <td>{{ interval.id }}</td>
            <td>{{ formatTime(interval.startSeconds) }}</td>
            <td>{{ formatTime(interval.endSeconds) }}</td>
            <td>{{ interval.type === 'WORK' ? 'Работа' : 'Перерыв' }}</td>
            <td>{{ duration(interval.startSeconds, interval.endSeconds) }}</td>
        </tr>
        </tbody>
    </table>
    <p v-else>Пока нет записей. Добавьте первую</p>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            const intervals = ref([])
            const message = ref('')
            const error = ref('')

            const form = ref({
                startTime: '',
                endTime: '',
                type: 'WORK'
            })

            const timeToSeconds = (time) => {
                if (!time) return 0
                const [h, m] = time.split(':')
                return parseInt(h) * 3600 + parseInt(m) * 60
            }

            const secondsToTime = (seconds) => {
                const h = String(Math.floor(seconds / 3600)).padStart(2, '0')
                const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0')
                return `${h}:${m}`
            }

            const formatTime = (seconds) => secondsToTime(seconds)

            const duration = (startSec, endSec) => {
                const diff = endSec - startSec
                const hours = Math.floor(diff / 3600)
                const minutes = Math.floor((diff % 3600) / 60)
                return `${hours} ч ${minutes} мин`
            }

            const loadIntervals = async () => {
                try {
                    const response = await fetch('api/intervals')
                    if (response.ok) {
                        intervals.value = await response.json()
                    } else {
                        error.value = 'Не удалось загрузить данные'
                    }
                } catch (err) {
                    error.value = 'Ошибка сети при загрузке'
                }
            }

            const addInterval = async () => {
                message.value = ''
                error.value = ''

                const payload = {
                    startSeconds: timeToSeconds(form.value.startTime),
                    endSeconds: timeToSeconds(form.value.endTime),
                    type: form.value.type
                }

                try {
                    const response = await fetch('api/intervals', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })

                    if (response.ok) {
                        message.value = 'Интервал успешно добавлен!'
                        form.value.startTime = ''
                        form.value.endTime = ''
                        await loadIntervals()
                    } else {
                        const errorText = await response.text()
                        error.value = errorText || 'Ошибка при сохранении'
                    }
                } catch (err) {
                    error.value = 'Ошибка сети при отправке'
                }
            }

            onMounted(() => {
                loadIntervals()
            })

            return {
                intervals,
                message,
                error,
                form,
                addInterval,
                formatTime,
                duration
            }
        }
    }).mount('#app')
</script>
</body>
</html>